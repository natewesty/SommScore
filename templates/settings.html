{% extends "base.html" %}

{% block extra_head %}
    <style>
        /* Add any settings-specific styles here */
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <header>
            <h1>SommScore Settings</h1>
        </header>

        <!-- Settings Card -->
        <div class="settings-card card">
            <h2 class="card-title">Settings</h2>
            
            <!-- General Settings Form -->
            <form id="generalSettingsForm" method="POST" action="{{ url_for('settings') }}">
                <div class="settings-section">
                    <h3>Year Type</h3>
                    <p class="section-description">Choose between calendar year or fiscal year for calculations.</p>
                    
                    <div class="year-type-options">
                        <label class="radio-option">
                            <input type="radio" name="year_type" value="calendar" 
                                   {% if year_type == 'calendar' %}checked{% endif %}
                                   onchange="toggleFiscalDates(false)">
                            <span>Calendar Year</span>
                        </label>
                        
                        <div class="fiscal-option">
                            <label class="radio-option">
                                <input type="radio" name="year_type" value="fiscal" 
                                       {% if year_type == 'fiscal' %}checked{% endif %}
                                       onchange="toggleFiscalDates(true)">
                                <span>Fiscal Year</span>
                            </label>
                            
                            <div class="fiscal-dates" id="fiscalDates" 
                                 {% if year_type != 'fiscal' %}style="display: none;"{% endif %}>
                                <div class="date-picker-group">
                                    <label class="date-label">
                                        Start:
                                        <input type="date" name="fiscal_start" 
                                               value="{{ fiscal_start }}"
                                               class="date-input">
                                    </label>
                                    <label class="date-label">
                                        End:
                                        <input type="date" name="fiscal_end" 
                                               value="{{ fiscal_end }}"
                                               class="date-input">
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Display Options</h3>
                    <p class="section-description">Customize how information is displayed on the dashboard.</p>
                    
                    <div class="display-options-grid">
                        <div class="control-card">
                            <div class="control-content">
                                <div class="control-info">
                                    <h3>Dark Mode</h3>
                                    <p>Switch between light and dark theme</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="dark_mode" {% if dark_mode == 'true' %}checked{% endif %}>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="control-card">
                            <div class="control-content">
                                <div class="control-info">
                                    <h3>Tip Leader Badges</h3>
                                    <p>Show badges for top tip earners</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" name="show_tip_badges" {% if show_tip_badges == 'true' %}checked{% endif %}>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-actions">
                    <button type="submit" class="save-button">Save Settings</button>
                    <a href="{{ url_for('index') }}" class="cancel-button">Cancel</a>
                </div>
            </form>
        </div>

        <!-- Operations Card -->
        <div class="settings-card card operations-card">
            <h2 class="card-title">Operations</h2>
            <div class="settings-section">
                <h3>Manual Score Update</h3>
                <p class="section-description">Run a manual update of SommScores for a specific date range.</p>
                
                <div class="control-card">
                    <div class="control-content">
                        <div class="manual-update-controls">
                            <div class="update-field text-center">
                                <label>Last Update</label>
                                <div class="date-display">
                                    <span class="last-update-time">{{ last_update_time }}</span>
                                </div>
                            </div>
                            <form id="manualUpdateForm" onsubmit="handleManualUpdate(event)">
                                <div class="update-field text-center">
                                    <label>Start Date</label>
                                    <input type="date" name="manual_start_date" required class="date-input">
                                </div>
                                <div class="update-field">
                                    <label>&nbsp;</label>
                                    <button type="submit" class="update-button">Run Update</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
    function toggleFiscalDates(show) {
        const fiscalDates = document.getElementById('fiscalDates');
        if (show) {
            fiscalDates.style.display = 'block';
            // If dates aren't set, set them to default values
            const startInput = document.querySelector('input[name="fiscal_start"]');
            const endInput = document.querySelector('input[name="fiscal_end"]');
            if (!startInput.value) {
                const currentYear = new Date().getFullYear();
                startInput.value = `${currentYear}-07-01`;
                endInput.value = `${currentYear + 1}-06-30`;
            }
        } else {
            fiscalDates.style.display = 'none';
        }
    }

    // Call toggleFiscalDates on page load if fiscal year is selected
    document.addEventListener('DOMContentLoaded', function() {
        const yearTypeRadios = document.querySelectorAll('input[name="year_type"]');
        yearTypeRadios.forEach(radio => {
            if (radio.checked && radio.value === 'fiscal') {
                toggleFiscalDates(true);
            }
        });
    });

    function applyTheme() {
        const darkMode = '{{ dark_mode }}' === 'true';
        document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
    }
    
    function toggleTheme(isDark) {
        // Apply theme immediately for preview
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    }
    
    // Apply theme immediately on page load
    applyTheme();
    </script>
    
    <script>
    async function handleManualUpdate(event) {
        event.preventDefault();
        
        const form = event.target;
        const startDate = form.manual_start_date.value;
        const updateButton = form.querySelector('.update-button');
        
        // Disable button and show loading state
        updateButton.disabled = true;
        
        try {
            const response = await fetch('/manual_update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    start_date: startDate
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                // Update the associates lists with new data
                const benchList = document.getElementById('benchList');
                const activeList = document.getElementById('activeList');
                const hiddenList = document.getElementById('hiddenList');
                
                // Clear existing lists
                benchList.innerHTML = '';
                activeList.innerHTML = '';
                hiddenList.innerHTML = '';
                
                // Helper function to create associate card
                function createAssociateCard(associate) {
                    return `
                        <div class="associate-card" draggable="true" data-associate="${associate}">
                            <div class="rank-header">
                                <span class="associate-name">${associate}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Populate active list
                result.active_associates.forEach(associate => {
                    activeList.insertAdjacentHTML('beforeend', createAssociateCard(associate));
                });
                
                // Populate hidden list
                result.hidden_associates.forEach(associate => {
                    hiddenList.insertAdjacentHTML('beforeend', createAssociateCard(associate));
                });
                
                // Populate bench list (associates that are neither active nor hidden)
                result.all_associates.forEach(associate => {
                    if (!result.active_associates.includes(associate) && !result.hidden_associates.includes(associate)) {
                        benchList.insertAdjacentHTML('beforeend', createAssociateCard(associate));
                    }
                });
                
                // Reinitialize drag and drop for new cards
                initializeDragAndDrop();
                
                alert(`Update completed successfully! ${result.message}`);
            } else {
                alert(`Error: ${result.error}`);
            }
        } catch (error) {
            alert('An error occurred while running the update.');
            console.error('Update error:', error);
        } finally {
            updateButton.disabled = false;
        }
    }
    
    // Function to initialize drag and drop functionality
    function initializeDragAndDrop() {
        const associateCards = document.querySelectorAll('.associate-card');
        const associateLists = document.querySelectorAll('.associates-list');
        
        associateCards.forEach(card => {
            card.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('text/plain', this.dataset.associate);
                this.classList.add('dragging');
                setTimeout(() => {
                    this.style.opacity = '0.5';
                }, 0);
            });

            card.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                this.style.opacity = '1';
                updateFormInputs();
            });
        });

        associateLists.forEach(list => {
            list.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });

            list.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });

            list.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                const associateName = e.dataTransfer.getData('text/plain');
                const card = document.querySelector(`.associate-card[data-associate="${associateName}"]`);
                
                if (card) {
                    this.appendChild(card);
                }
            });
        });
    }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the general settings form
        const generalSettingsForm = document.getElementById('generalSettingsForm');
        
        // Add submit handler for the general settings form
        generalSettingsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get all the current values
            const formData = new FormData(this);
            
            // Submit the form
            fetch(this.action, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    // Redirect to index page on success
                    window.location.href = "{{ url_for('index') }}";
                } else {
                    console.error('Failed to save settings');
                    alert('Failed to save settings. Please try again.');
                }
            }).catch(error => {
                console.error('Error saving settings:', error);
                alert('An error occurred while saving settings. Please try again.');
            });
        });
    });
    </script>
{% endblock %} 